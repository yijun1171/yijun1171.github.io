<!doctype html>
<html class="theme-next use-motion theme-next-mist">
<head>
  

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />








  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>




<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.5.1"/>


    <meta name="description" content="coding | java | life" />



  <meta name="keywords" content="Keep hungry. Keep foolish" />





  <link rel="shorticon icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.1" />


<meta name="description" content="coding | java | life">
<meta property="og:type" content="website">
<meta property="og:title" content="Eden">
<meta property="og:url" content="http://yijun1171.github.io/index.html">
<meta property="og:site_name" content="Eden">
<meta property="og:description" content="coding | java | life">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Eden">
<meta name="twitter:description" content="coding | java | life">


<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: 'Mist',
    sidebar: 'post'
  };
</script>

  <title> Eden </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  



  <div class="container one-column 
   page-home 
">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><h1 class="site-meta">
  <span class="logo-line-before"><i></i></span>
  <a href="/" class="brand" rel="start">
      <span class="logo">
        <i class="icon-next-logo"></i>
      </span>
      <span class="site-title">Eden</span>
  </a>
  <span class="logo-line-after"><i></i></span>
</h1>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon icon-next-home"></i> <br />
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            <i class="menu-item-icon icon-next-about"></i> <br />
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            <i class="menu-item-icon icon-next-archives"></i> <br />
            归档
          </a>
        </li>
      

      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content"> 
  <section id="posts" class="posts-expand">
    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/09/10/《Linux内核设计与实现》读书笔记/" itemprop="url">
                《Linux内核设计与实现》读书笔记
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-09-10T16:37:28+08:00" content="2015-09-10">
            2015-09-10
          </time>
        </span>

        

        
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><h2 id="《Linux内核设计与实现》读书笔记">《Linux内核设计与实现》读书笔记</h2><h3 id="进程管理">进程管理</h3><p>进程相关的资源描述都保存在 <em>task_struct</em> 结构中， <em>task_struct</em> 的创建和销毁是有slab分配器管理的，同时利用 <strong>写时复制</strong> 技术，最大限度的减小进程创建的开销</p>
<p>Linux中线程实现为一种特殊的进程，通过和进程类似的创建方式进行创建(通过控制 <em>clone</em> 方法的参数)。<br>还有一些内核线程在内核空间执行内核制定的后台操作。如 <em>flush</em></p>
<h4 id="进程树">进程树</h4><p>根进程是PID为1的进程，在系统启动时最先启动的进程。<br><em>task_struct</em> 结构中保存了指向父进程的指针和指向子进程的指针链表，逻辑上构成了一个进程树</p>
<h4 id="进程创建">进程创建</h4><p>进程创建分为两步：</p>
<ol>
<li><em>fork</em>：从父进程拷贝数据</li>
<li><em>exec</em>：启动进程</li>
</ol>
<h4 id="进程销毁">进程销毁</h4><p>进程调用 <em>exit</em> 之后，会释放大部分资源，并且进程状态设置为 <em>EXIT_ZOMBIE</em>，永远不会被CPU调度。但是PID和 <em>task_struct</em> 此时并没有被释放</p>
<p>只有当父进程调用 <em>wait</em> 之后进程的所有独占资源，包括PID和 <em>task_struct</em> 才会真正回收</p>
<ol>
<li>孤儿进程：当父进程先于子进程结束，内核需要在父进程的兄弟进程中为那些子进程寻找<strong>养父</strong>，如果寻找不到，这些子进程就成了孤儿进程，被托管给init进程。</li>
<li>僵尸进程：当父进程结束时没有调用 <em>wait</em> 就先于子进程结束时，那些子进程就成了没有父进程的僵尸进程，他们占用的PID就永远不会被收回，那些资源又是有限的，这就会对系统资源造成浪费。</li>
</ol>
<h3 id="进程地址空间">进程地址空间</h3><p><img src="/img/process-address-space.jpg" alt=""><br>虚拟地址空间由 <em>mm_struct</em> 结构描述；地址空间中的各个段，如代码段，数据段，共享内存段，栈等，由 <em>vm_area_struct</em> 称为VMA。</p>
<p>进程地址空间管理大部分都在与对VMA的操作</p>
<h4 id="VMA的分配与销毁">VMA的分配与销毁</h4><ol>
<li>创建地址空间：do_mmap()</li>
<li>销毁地址空间：do_mummap()</li>
</ol>
<p>系统调用mmap和mummap是对他们的一层封装<br>do_mmap 的调用参数 file<br>如果传入参数fd，则表明是一个文件映射。如果传入null，则是匿名映射，扩展堆空间大概就是这么调用的。</p>
<h3 id="系统调用">系统调用</h3><p>应用程序 -&gt; API -&gt; 系统调用 -&gt; 内核程序</p>
<p>Unix的接口设计原则：提供机制，而不是策略。对于我们开发中的接口设计也有参考价值。尽量将接口设计成原子性的，基础的操作，强调上层对他们的组合调用。</p>
<h4 id="工作模式">工作模式</h4><p>每个系统调用关联一个 <strong>系统调用号</strong> ，保存在 <em>sys_call_table</em> 中。<br>通过软中断，产生异常陷入内核，对应的中断处理程序就是系统调用处理程序。<br>将中断号和调用参数保存在寄存器中，传递给系统调用。</p>
<h3 id="中断">中断</h3><p>为了消除处理器和外围硬件设备的速度差异，而采取的一种通信方式<br><strong>中断号</strong> 与特定中断设备相关联，不同的中断又有不同的中断处理程序来响应。<br>为了使得中断处理程序快速执行，并且完成大量的工作，内核将中断处理分为两部分：</p>
<ol>
<li>上半部(top half)：响应中断，复位硬件，做简单的操作</li>
<li>下半部(bottom half)：处理复杂的任务</li>
</ol>
<h3 id="内存管理">内存管理</h3><h4 id="Slab分配器">Slab分配器</h4><p><img src="/img/slab.gif" alt=""><br>用于内核级的内存管理，主要用于大量的小内存对象的分配和释放。<br>大多数的内核级结构对象，都是从这里获得的，如上面提到的 <em>mm_struct</em>， <em>VMA</em> ，还有 <em>bio</em> 等等</p>
<h3 id="虚拟文件系统">虚拟文件系统</h3><p>VFS提供了一层抽象，一组通用数据结构，一组通用接口，使得用户空间能通过统一的系统调用访问各种文件系统。</p>
<ul>
<li>super：文件系统元数据，<em>super_block</em>。例如磁盘，将文件系统的超级对象存在特定扇区中，文件系统安装时，将这部分信息读取出来，在内存中填充成 <em>super_block</em> 结构</li>
<li>inode：文件元数据</li>
<li>dentry：目录项</li>
<li>file：文件</li>
</ul>
<h3 id="块设备">块设备</h3><p>块(block)，是VSF的最小寻址单位。一个块大小要求是扇区大小(512B)的整数倍，并且小于等于页面大小。通常一个块大小为512B，1KB，4KB，视体系结构而定。</p>
<h4 id="关键数据结构">关键数据结构</h4><ol>
<li>缓冲区头：一个块对应一个内存缓冲区，缓冲区头 <em>buffer_head</em> 就用来描述一个缓冲区。它表示的粒度很小</li>
<li>bio：多个片段，每个片段是一小块连续的内存缓冲区。它表示的粒度更大。<br>一次IO请求表示为 <em>request</em>，它可能由多个 <em>bio</em> 组成</li>
</ol>
<h4 id="IO调度">IO调度</h4><p>为了优化磁盘的寻址时间，IO调度程序会对到来的IO请求进行 <strong>合并</strong> 和 <strong>排序</strong>。<br>因为读请求多是同步的，而写请求可以是异步的，所以优化的时候，首先要保证读不超时。</p>
<ol>
<li>老旧的linux电梯算法：简单合并与插入排序，可能会导致饥饿。</li>
<li>deadline：划分读写队列，保证没有请求饥饿，但是频繁的读写响应会降低吞吐量</li>
<li>Anticipatory：在deadline基础上为了提高吞吐量，每次读请求处理完毕之后，不立即返回，而是等待，如果有相邻扇区的IO请求到来，则可以减少寻道时间。</li>
<li>CFQ：为每个进程划分请求队列，轮训调度，保证高负荷的情况下也有很好的表现</li>
<li>Noop：只做合并不做排序，使用与随机读写设备。如SSD</li>
</ol>
<h4 id="页缓存和回写">页缓存和回写</h4><p>页缓存是在磁盘之上的一层内存缓存，顾名思义是以页面为单位的。<br>读命中，直接从页缓存中取数据；未命中则去磁盘请求，然后更新缓存。<br><img src="/img/Page-cache.jpg" alt=""></p>
<p>主要的写策略有3种</p>
<ol>
<li>缓存穿透，不使用缓存，直接写磁盘</li>
<li>同步写，先写缓存，再写磁盘，整个过程分为2部分，保证数据的一致性</li>
<li>异步写，写完缓存就返回。由内核线程将缓存数据和磁盘同步，成为 <strong>写回</strong></li>
</ol>
<p>淘汰策略：<br>Linux使用修改过的LRU，称为 <strong>双链策略</strong><br><a href="http://www.ibm.com/developerworks/cn/linux/l-cache/" target="_blank" rel="external">Linux内核的文件Cache管理机制简介</a></p>
<p>flusher线程写回条件</p>
<ol>
<li>内存不足，写回脏页释放内存。阈值通过 <em>dirty_background_ratio</em> 设置</li>
<li>脏页驻留时间超过阈值。内核线程会被周期性唤醒，写回过期的脏页</li>
<li>主动调用sync fsync刷盘。</li>
</ol>
<p>可以通过/proc/sys/vm 设置写回参数</p>
<p>最后附上Linux IO栈：<br><img src="/img/linux-io-stack-diagram_v0.11-724x1024.jpg" alt=""></p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/09/09/实习总结/" itemprop="url">
                实习总结
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-09-09T17:38:49+08:00" content="2015-09-09">
            2015-09-09
          </time>
        </span>

        

        
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><h2 id="阿里实习总结">阿里实习总结</h2><p>5.14-8.31，在阿里百川&amp;TAE实习104天。</p>
<h3 id="感受">感受</h3><p>阿里的工作环境和员工待遇真的挺好，起码作为实习生在杭州可以生活的很舒服。<br>关于 <strong>加班</strong>，绝大部分的部门都是在加班的。在我看来，很多人都是白天不停的开会，评审，好多工作都只能晚上加班来安安静静的做。<br>关于 <strong>HR</strong>，就我接触到的HR和HRG来说，并没有网上黑的那么严重- -。我想毕竟公司大了，什么样的人都有，反正我在实习生群里没有看到多少吐槽HR和HRG的。<br>关于 <strong>同事</strong>，师兄师姐人都很nice，都是有问必答。印象深刻的是组里的师兄开玩笑的尺度都是没有下限的- -，但是团队氛围还是超级好，起码在部门以及boss的压力下在尽大家所能在认认真真做东西。<br>关于 <strong>部门</strong>，大公司，决定你的工作环境，团队氛围，成长空间的，都取决与你所在的部门，当然，包括老板。TAE是集团百川业务的底层技术平台，老板的压力很大，项目推进和迭代的速度很快，快到让我觉得有些虚浮，好像产品前进的脚步走得并不那么扎实。<br>关于 <strong>产品</strong>，虽然说老板有老板的KPI，员工有员工的KPI，大家压力都很大，但是我总觉得对产品细节和体验的雕琢不够，也就导致了自然引流过来的用户很难留住和转化。其实核心竞争力还是有的，但是让人用的就是不爽!这就是问题啊。</p>
<p>阿里是个大公司，很普通的大公司，没那么好，也没那么糟。</p>
<h3 id="收获">收获</h3><h4 id="项目">项目</h4><p>跟完一个完整的项目，是做内部监控和可视化展现(展现做的很low，前端水平有限，需要着重锻炼)。监控系统的数据来源都是其他系统，例如日志架构的某个节点，请求链路中的某个集群等等，都是分布式的环境。写代码的时候就要考虑到网络环境的因素(不是所有的通信都通过RPC，还有直接用HTTP交互数据的)，要保证网络抖动和不稳定时，程序的健壮性。<br>另一点就是合理和认真的处理异常。有一部分异常甚至成为了监控的业务逻辑，比如说，对某一个域名的请求超时，抛出超时异常，监控要能够判断出是读超时，还是连接超时，并合理报警。没有合理的异常体系设计和认真处理，是会漏掉很多case的。<br>对原有代码进行了部分重构，逐渐学会在设计时考虑程序的可扩展性。<strong>对修改关闭对扩展开放</strong>。</p>
<h4 id="通用技能">通用技能</h4><ol>
<li>学了一些Linux环境的基本运维技能</li>
<li>深入理解了Linux的IO栈，顺带复习了一下段页式虚存管理</li>
<li>排查线上问题的通用方法</li>
</ol>
<h4 id="长见识">长见识</h4><p>团队每周的技术分享还是很赞的，而且并不是每个团队都有这样的机会。<br>听了不少云产品的设计和实现，看了自己部门一些系统的架构设计。<br>从一开始带着星星眼去听，到后来带着问题和思考去听。为什么这么设计，难点在哪里，收获也是不少。</p>
<h4 id="吐槽">吐槽</h4><p>如果不做好配置管理和环境隔离，对开发简直是灾难！大公司都会有好几套代码环境，例如日常开发环境，测试环境，集成环境，线上环境。<br>我负责的监控系统会依赖很多的外部系统，大部分是采集监控数据的源点。然而在日常开发环境下，某些外部系统并没有部署，也就是说整个监控系统在日常下不能启动，我也就不能在开发时拿到像样的外部数据进行足够的单元测试，更别说debug了……<br>真实的数据只能到集成环境上面去拿，搞得我在集成环境里测试和修改，开发效率极低，而且很不爽。</p>
<p>项目管理实在是不规范，我吓了一跳。部门内部的JDK版本都不统一，没有统一的Coding Style，文档匮乏，槽点实在太多……</p>
<p>当然我能想象，在大量业务压力和时间逼迫下，工程师写下的每一行救火代码。但是好的代码习惯还是要保持的，毕竟对自己对他人都有好处。多谢师兄在如此不堪的大环境下，对我的严格要求。</p>
<h4 id="思考">思考</h4><ol>
<li>遇事要主动，尤其是需要其他人配合的时候。可能刚实习的时候，还是把自己定位为无关紧要的实习生，不太好意思找其他同事配合和援助。后来慢慢才认识到，工作上的事情一定要主动，主动，主动！重要的事情说3遍。尤其是一个人搞不定的时候。</li>
<li>要把自己融入团队，首先要把自己的定位放在团队里。我是团队的一员，才会更多的从团队的角度去考虑，去做一些有益与团队和产品的事。</li>
<li>遇到问题的第一反应是吐槽，然后必须是想办法解决它！干掉它！消灭它！不然公司给你钱是干嘛使得！其实蛮遗憾没去使劲解决项目的配置管理的问题。这就是教训吧……</li>
<li>以后要保持敬畏，对线上保持敬畏，对那些看起来难以掌控的满身槽点的项目保持敬畏(很有可能是你能力不够才没法让他变成看起来舒服的样子)</li>
</ol>
<h3 id="遗憾">遗憾</h3><ol>
<li>代码还是写得太少，实现很难说做到优雅</li>
<li>在阿里呆的3个月，很少和其他学校的优秀实习生交流，没有通过他们的成长和学习经验，来激励自己</li>
<li>和主管还是师兄私下沟通和聊天太少(但是他们每天都忙成啥了……)，聊行业聊技术聊选择，以后要点上科学扯淡这个技能！</li>
</ol>
<h3 id="打算">打算</h3><ol>
<li>先努力找个满意的工作</li>
<li>工作之余多写代码，多造轮子，尽量造业界新的技术的轮子</li>
<li>英语啊！u little bastard！</li>
<li>多接触牛人，闲来吹水，认真时请教</li>
</ol>
<h3 id="关于缩招">关于缩招</h3><ol>
<li>就公司这个做法，可能不是那么厚道，但是从法律和公司利益角度，它确实是合理的，求新求变就意味着要割肉，割肉当然从最不痛的开始割，谁让你是实习生。</li>
<li>就我个人而言，可能是我学艺不精，没能成为那些公司舍不得割的部分。起码我和公司两不相欠，我学到和收获了很多，也给公司干了不少活。</li>
</ol>
<p>拥抱变化，等NB了，回去甩它一脸。恩。</p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/08/10/句柄监控优化/" itemprop="url">
                句柄监控优化
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-08-10T14:23:35+08:00" content="2015-08-10">
            2015-08-10
          </time>
        </span>

        

        
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><h3 id="脚本">脚本</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsof -n | awk &#39;&#123;print $2&#34;_&#34;$3&#125;&#39;|sort|uniq -c &#62; pid_fds &#10;&#10;ps aux | grep &#34;\-Dcatalina.home=/home\|ACE\-uWSG\|php\-fpm&#34;|grep -v &#34;grep&#34; | awk &#39;&#123;print $2&#34;_&#34;$1&#125;&#39; &#62; pids&#10;&#10;for pid in `cat pids`&#10;do&#10;  echo `grep &#34;$pid&#34;  `&#10;done</span><br></pre></td></tr></table></figure>
<p>这是VM虚拟机上句柄监控的采集脚本，主要目的是统计以下三个进程打开的句柄数量</p>
<ul>
<li>-Dcatalina.home=/home</li>
<li>ACE-uWSG</li>
<li>php-fpm</li>
</ul>
<p>线上进行链路压测时发现，这段脚本的执行会导致CPU负载飙升。</p>
<h3 id="lsof">lsof</h3><p><em>lsof</em> 是一个很常用的问题排查工具，它能列出系统中打开的文件句柄。</p>
<blockquote>
<p>Lsof revision 4.78 lists information about files opened by processes.</p>
<p>An open file may be a regular file, a directory, a block special file, a character special file, an executing text reference, a library, a stream or a network file  (Internet socket, NFS file or UNIX domain socket.)</p>
</blockquote>
<p>这是man手册中对lsof的描述，文件句柄可能包括：</p>
<ul>
<li>普通文件</li>
<li>目录</li>
<li>块文件（块设备）</li>
<li>字符文件（字符设备）</li>
<li>正在执行中的文件的引用</li>
<li>库</li>
<li>流</li>
<li>socket和NFS</li>
</ul>
<p>linux中一切都是文件 : )<br>我们可以通过指定参数，展示某些具体进程或者目录下打开的句柄（-p +d），具体使用方法参考这篇文档，不再赘述。<a href="http://www.thegeekstuff.com/2012/08/lsof-command-examples/" target="_blank" rel="external">15 Linux lsof Command Examples </a></p>
<h4 id="工作方式">工作方式</h4><blockquote>
<p>Lsof obtains data about open UNIX dialect files by reading the kernel’s proc structure information, following it to the related user structure, then reading the open file structures stored (usually) in the user structure.  Typically lsof uses the kernel memory devices, /dev/kmem, /dev/mem, etc. to read kernel data.</p>
</blockquote>
<p>from–<a href="http://www.opensource.apple.com/source/lsof/lsof-8/lsof/00PORTING" target="_blank" rel="external">Guide to Porting lsof 4 to Unix OS Dialects</a></p>
<p>根据参考资料，<em>lsof</em> 通过读取内核中的 <em>proc</em> 数据结构，并根据他们去获取用户的相关信息，然后读取存储在用户数据结构中的句柄信息。<br><img src="http://gtms02.alicdn.com/tps/i2/TB1kT3xIpXXXXXdapXXTKgvNFXX-581-419.gif" alt="进程相关data_structure"></p>
<p>实际上句柄就是上图中fd_array的 <strong>下标</strong> ，如果某个进程打开了某个”文件”，对应的数组元素就会指向其文件的元信息。</p>
<h3 id="优化方案">优化方案</h3><p>师兄给出了两个他曾经考虑过的方案</p>
<ul>
<li>lsof -p pid</li>
<li>ls /proc/pid/fd</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsof -p pid | wc -l&#10;&#10;--------------------------&#10;&#10;ls -l /proc/pid/fd | wc -l&#10;&#10;&#32467;&#26524; 497 : 298</span><br></pre></td></tr></table></figure>
<p>然而问题发生了，查看同一个进程打开的句柄，两种方案给出的执行结果却不一样。lsof命令的执行结果比另一个方案，多出好几百条句柄。</p>
<p>我试着把两种方案的结果dump到本地</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsof -n -p 165926 | awk &#39;&#123;if($5==&#34;REG&#34;) print $9&#34;_&#34;$8&#34;_&#34;$4;else print $8&#34;_&#34;$7&#34;_&#34;$4&#125;&#39; | sort &#62; fd_lsof&#10;&#10;ls -il /proc/165926/fd |grep -v &#34;total&#34;| awk &#39;&#123;print $12&#34;_&#34;$1&#125;&#39; | sort &#62; fd_proc</span><br></pre></td></tr></table></figure>
<p>用 <em>Beyond Compare</em> 进行比对，发现了以下情况<br><img src="http://gtms01.alicdn.com/tps/i1/TB1FF3vIFXXXXXOXVXXeOiDRFXX-1161-477.jpg" alt=""></p>
<p>左边是proc/pid/fd的结果，右边是lsof命令的结果</p>
<ol>
<li>lsof除了列出该进程对所有jar包的访问而产生的句柄外，还列出了同一个jar包作为共享库的句柄。（我将句柄类型输出到了右边的末尾，mem就表示内存映射的句柄）</li>
<li>除此之外，lsof还列出了以 <em>.so</em> 结尾的库文件</li>
</ol>
<p>库文件以内存映射方式加载到内存中，lsof将其又统计了一遍，导致结果数量和proc方式不一致。<br>并且很有意思的是那些mem类型的输出，他们inode的指向和对应句柄的inode指向是一致的，也就是说，他们本质上打开的是同一个文件。<br>因此，将mem类型的输出过滤掉就ok了。</p>
<h3 id="参考资料">参考资料</h3><ol>
<li><a href="http://www.thegeekstuff.com/2012/08/lsof-command-examples/" target="_blank" rel="external">15 Linux lsof Command Examples </a></li>
<li><a href="http://www.opensource.apple.com/source/lsof/lsof-8/lsof/00PORTING" target="_blank" rel="external">how lsof works</a></li>
</ol>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/06/11/日志链路健康检查总结/" itemprop="url">
                日志链路健康检查总结
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-06-11T23:54:37+08:00" content="2015-06-11">
            2015-06-11
          </time>
        </span>

        

        
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><h2 id="系统环境">系统环境</h2><ol>
<li>淘宝主站</li>
<li>阿里云</li>
<li>共享区</li>
</ol>
<p>整个日志系统是跨机房，跨region搭建的(底层依赖<strong>阿里云</strong>，对外的开放服务则搭建在<strong>淘宝主站</strong>)，不同的region之间网络不通（除开放的公网地址），所以存在logService这样具有<strong>代理</strong>性质的服务组件．</p>
<blockquote>
<p>跨网的数据传输会有比较大的延时，这点可以从jstorm的优化看出来</p>
</blockquote>
<h2 id="系统角色">系统角色</h2><ol>
<li>workstation：对外提供服务的<strong>界面</strong></li>
<li>logAgent：VM上的日志采集进程，也是日志链路的起点</li>
<li>logService：跨Region提供日志服务的代理</li>
<li>jstorm：实时计算处理集群,按一定规则将所有的日志进行封包,保证日志的<strong>局部有序</strong>和<strong>不丢失</strong>，同时将处理好的日志写入SLS</li>
<li>ONS：提供消息服务，暂存未处理的日志和实时日志</li>
<li>SLS：提供查询日志服务<h2 id="设计">设计</h2></li>
</ol>
<p>本监控项共覆盖四条日志链路,包括<strong>应用查询日志</strong>,<strong>应用实时日志</strong>,<strong>访问查询日志</strong>,<strong>访问实时日志</strong>，主要完成的功能是检查日志链路的<strong>源端</strong>和<strong>尾端</strong>会不会存在日志丢包，方便日后日志问题的定位．</p>
<h3 id="业务逻辑">业务逻辑</h3><ol>
<li><p>部署一个WEB应用(以下称为<strong>目标应用</strong>)在容器中，监控项定时向WEB应用暴露出的URL发送HTTP请求.</p>
<ul>
<li>/print，负责打印指定数量的日志．这部分产生的日志属于应用日志，通过我们自己实现的<strong>LogAppender</strong>将日志信息写入容器所在vm．</li>
<li>/acess, 一个空白URL，没有实际操作，接入层的Nginx记录URL请求，并产生访问日志.</li>
</ul>
</li>
<li><p>在监控项中,采集日志链路终端的数据，检查是否丢失日志</p>
<ul>
<li>通过SLS提供的接口检查是不是所有的日志都被成功持久化</li>
<li>通过<strong>jaeLogService</strong>提过的代理服务，取到ONS中的实时日志，检查是不是所有的日志都能被成功写入．</li>
</ul>
</li>
</ol>
<h3 id="模块设计">模块设计</h3><p>遵循现有监控项的设计,总体业务逻辑分为三部分:<strong>Collector</strong>,<strong>Processor</strong>,<strong>Strategy</strong>.数据以<strong>MonitorItem</strong>对象的形式在三部分组成的<strong>流水线</strong>中流动.典型的链式程序设计.</p>
<h4 id="Collector">Collector</h4><p>监控数据的产生起点,根据业务要求从不同的地方收集监控数据,将达到报警要求的数据封装成<strong>MonitorItem</strong>交给下一级.</p>
<h4 id="Processor">Processor</h4><p>向<strong>Collector</strong>产生的报警项中按业务要求写入对应的报警信息,然后传递给下一级</p>
<h4 id="Strategy">Strategy</h4><p>将<strong>Processor</strong>传递过来的报警项存入DB</p>
<p>纵观三个过程,<strong>Collector</strong>是最核心的部分,它决定了监控的数据收集策略,判断是否达到报警阈值,封装报警数据.它也是和外部系统打交道最多的模块.</p>
<blockquote>
<p>顺便说一下,项目组依赖的外部系统真的非常多,尤其是对<strong>阿里云</strong>的依赖.整个容器建立在<strong>ACE</strong>的VM上(这也是大部分监控数据的来源),KV缓存使用<strong>OCS</strong>,日志的持久化存储使用<strong>SLS</strong>,利用<strong>ONS</strong>消息服务提供实时日志服务，利用<strong>alimonitor</strong>完成监控报警(报警通知到手机，邮件，旺旺等)</p>
</blockquote>
<h2 id="遇到的问题">遇到的问题</h2><ol>
<li>最开始写代码的时候只要求覆盖一条日志链路，没有考虑扩展性，导致后来添加日志链路的时候进行了代码重构．</li>
<li>实时日志查询丢包问题．<ul>
<li>实时日志是经Jstorm封包(<strong>所有</strong>容器日志和访问日志)处理后，存入ONS，供LogService拉取，并对workstation提供服务．关键在LogService的日志拉取策略,第一次拉取是从队尾(ONS可以简单视为队列模型)向前追溯10个日志包，以此作为实时日志在队列中的的<strong>起始偏移量</strong>．日志拉取后，偏移量增加并存入OCS</li>
<li>问题出在我的<strong>日志采集策略</strong>和起始偏移量的<strong>向前追溯</strong>.<ul>
<li>采集策略：目标应用产生日志-&gt;采集实时日志-&gt;等待日志写入SLS-&gt;采集查询日志</li>
<li>向前追溯：很可能由于日志量过大,导致一部分包含<strong>目标应用</strong>相关日志的包写入ONS后,大量的包紧随其后,仅仅向前追溯10个包，不能保证起始偏移量在所有<strong>目标日志包</strong>之前.所以会出现实时日志丢失</li>
</ul>
</li>
<li>改变采集策略<ul>
<li>线上的实时日志应用场景一般是这样：用户需要查看实时日志定位问题-&gt;打开实时日志(logService将起始偏移量定位好)-&gt;用户进行某些产生日志的操作-&gt;日志封包进入ONS队尾(这时可以保证偏移量一定在所有<strong>目标日志包</strong>之前)-&gt;拉取实时日志</li>
<li>因此，采集策略改为：打开实时日志采集开关(先定位起始偏移量)-&gt;产生目标日志-&gt;等待日志写入SLS-&gt;采集查询日志</li>
</ul>
</li>
</ul>
</li>
<li>二套环境自动同步主干代码，导致同样的操作会执行两次，干扰线上日志正常采集．主要原因还是没有将<strong>产生日志</strong>这些关键性操作设计成<strong>幂等</strong>操作．以后要多注意．</li>
<li>沟通与协作．依赖的外部系统多，架构复杂，必然需要经常和其他部门和师兄沟通．难免会出现诸多问题．以后要勇于<strong>礼貌且合理</strong>地向外寻求协助</li>
</ol>
<h2 id="感悟">感悟</h2><ol>
<li>熟悉了整个<strong>日志链路</strong>和大致的处理过程</li>
<li>以后设计程序的时候先尽量明确完整的需求，充分考虑扩展的问题，<strong>面向抽象</strong>去设计，并多注意模块的高内聚，低耦合．</li>
<li>合理地<strong>处理异常</strong>．工程代码一定要保证<strong>稳定</strong>和<strong>可靠</strong>．要注意不能出现异常导致程序crash的情况．<ul>
<li>能处理的异常一定要处理，不能处理的向上抛出</li>
<li>结合日志帮助错误定位</li>
<li>注意RuntimeException也要捕获</li>
</ul>
</li>
</ol>
<blockquote>
<p>感谢师兄们耐心的帮助．：）</p>
</blockquote>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/05/11/ATF-感悟/" itemprop="url">
                ATF-感悟
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-05-11T21:24:51+08:00" content="2015-05-11">
            2015-05-11
          </time>
        </span>

        

        
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <h1 id="阿里巴巴技术论坛(ATF)体验有感">阿里巴巴技术论坛(ATF)体验有感</h1>
          <div class="post-more-link text-center">
            <a class="btn" href="/2015/05/11/ATF-感悟/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/05/09/ali-intern-linux-TCP/" itemprop="url">
                ali-intern-linux&TCP
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-05-09T16:46:10+08:00" content="2015-05-09">
            2015-05-09
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; 分类于
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/categories/linux-TCP/" itemprop="url" rel="index">
                  <span itemprop="name">linux TCP</span>
                </a>
              </span>

              
              

            
          </span>
        

        
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <p>linux文件系统概念和TCP<br>
          <div class="post-more-link text-center">
            <a class="btn" href="/2015/05/09/ali-intern-linux-TCP/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/05/01/ali-intern-java基础整理/" itemprop="url">
                ali-intern-java基础整理
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-05-01T14:49:10+08:00" content="2015-05-01">
            2015-05-01
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; 分类于
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/categories/java/" itemprop="url" rel="index">
                  <span itemprop="name">java</span>
                </a>
              </span>

              
              

            
          </span>
        

        
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <p>记录一些java基础的学习笔记</p>
          <div class="post-more-link text-center">
            <a class="btn" href="/2015/05/01/ali-intern-java基础整理/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/03/30/ANTLR4学习笔记-语法字典-Grammar-Lexicon/" itemprop="url">
                ANTLR4学习笔记
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-03-30T11:17:15+08:00" content="2015-03-30">
            2015-03-30
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; 分类于
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/categories/ANTLR/" itemprop="url" rel="index">
                  <span itemprop="name">ANTLR</span>
                </a>
              </span>

              
              

            
          </span>
        

        
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <h2 id="ANTLR4文法文档的基本书写语法,参考ANTLR官方文档,版本V4">ANTLR4文法文档的基本书写语法,参考ANTLR官方文档,版本V4</h2>
          <div class="post-more-link text-center">
            <a class="btn" href="/2015/03/30/ANTLR4学习笔记-语法字典-Grammar-Lexicon/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2014/12/27/golang-concurrency/" itemprop="url">
                golang-concurrency-学习笔记
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2014-12-27T14:24:35+08:00" content="2014-12-27">
            2014-12-27
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; 分类于
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/categories/golang/" itemprop="url" rel="index">
                  <span itemprop="name">golang</span>
                </a>
              </span>

              
              

            
          </span>
        

        
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <h1 id="golang并发编程学习笔记">golang并发编程学习笔记</h1><p>主要涉及channel goroutine 同步<br>参照阅读&lt;&lt; Go并发编程实战 &gt;&gt;</p>
          <div class="post-more-link text-center">
            <a class="btn" href="/2014/12/27/golang-concurrency/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2014/12/15/golang-RPC/" itemprop="url">
                CMU.Distributed-System.Lab1(RPC)
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2014-12-15T21:19:19+08:00" content="2014-12-15">
            2014-12-15
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; 分类于
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/categories/golang/" itemprop="url" rel="index">
                  <span itemprop="name">golang</span>
                </a>
              </span>

              
              

            
          </span>
        

        
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <p>RPC的一些基本概念和基于golang的简单实现</p>
          <div class="post-more-link text-center">
            <a class="btn" href="/2014/12/15/golang-RPC/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">&raquo;</a>
  </nav>

 </div>

        

        
      </div>

      
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      <section class="site-overview">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="/img/images.jpg" alt="Yijun" itemprop="image"/>
          <p class="site-author-name" itemprop="name">Yijun</p>
        </div>
        <p class="site-description motion-element" itemprop="description">coding | java | life</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">15</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            
              <span class="site-state-item-count">4</span>
              <span class="site-state-item-name">分类</span>
              
          </div>

          <div class="site-state-item site-state-tags">
            
              <span class="site-state-item-count">6</span>
              <span class="site-state-item-name">标签</span>
              
          </div>

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/yijun1171" target="_blank">Github</a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner"> <div class="copyright" >
  
  &copy; &nbsp; 
  <span itemprop="copyrightYear">2015</span>
  <span class="with-love">
    <i class="icon-next-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Yijun</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


 </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  
  
    
    

  


  
  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.1"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.1"></script>
  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/js/motion_global.js?v=0.4.5.1" id="motion.global"></script>




  <script type="text/javascript" src="/js/nav-toggle.js?v=0.4.5.1"></script>
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  

  <script type="text/javascript">
    $(document).ready(function () {
      if (CONFIG.sidebar === 'always') {
        displaySidebar();
      }
      if (isMobile()) {
        FastClick.attach(document.body);
      }
    });
  </script>

  

  
  

  
  <script type="text/javascript" src="/js/lazyload.js"></script>
  <script type="text/javascript">
    $(function () {
      $("#posts").find('img').lazyload({
        placeholder: "/images/loading.gif",
        effect: "fadeIn"
      });
    });
  </script>
</body>
</html>
